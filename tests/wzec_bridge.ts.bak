import * as anchor from "@coral-xyz/anchor";
import { Program } from "@coral-xyz/anchor";
import { WzecBridge } from "../target/types/wzec_bridge";
import { TOKEN_PROGRAM_ID } from "@solana/spl-token";

describe("wzec-bridge", () => {
  const provider = anchor.AnchorProvider.env();
  anchor.setProvider(provider);

  const program = anchor.workspace.WzecBridge as Program<WzecBridge>;

  let bridgeConfigPda: anchor.web3.PublicKey;
  let mintAuthorityPda: anchor.web3.PublicKey;
  let szecMintPda: anchor.web3.PublicKey;

  before(async () => {
    // Derive PDAs
    [bridgeConfigPda] = anchor.web3.PublicKey.findProgramAddressSync(
      [Buffer.from("bridge-config")],
      program.programId
    );

    [mintAuthorityPda] = anchor.web3.PublicKey.findProgramAddressSync(
      [Buffer.from("mint-authority")],
      program.programId
    );

    [szecMintPda] = anchor.web3.PublicKey.findProgramAddressSync(
      [Buffer.from("szec-mint")],
      program.programId
    );
  });

  it("Initializes the bridge", async () => {
    const admin = provider.wallet.publicKey;
    const enclaveAuthority = anchor.web3.Keypair.generate().publicKey;
    const mpcAuthority = anchor.web3.Keypair.generate().publicKey;

    try {
      const tx = await program.methods
        .initBridge(enclaveAuthority, mpcAuthority)
        .accounts({
          admin: admin,
          bridgeConfig: bridgeConfigPda,
          szecMint: szecMintPda,
          mintAuthority: mintAuthorityPda,
          tokenProgram: TOKEN_PROGRAM_ID,
          systemProgram: anchor.web3.SystemProgram.programId,
          rent: anchor.web3.SYSVAR_RENT_PUBKEY,
        })
        .rpc();

      console.log("\nBridge initialized successfully!");
      console.log("Transaction:", tx);
      console.log("Bridge Config PDA:", bridgeConfigPda.toString());
      console.log("sZEC Mint:", szecMintPda.toString());
      console.log("Admin:", admin.toString());
      console.log("Enclave Authority:", enclaveAuthority.toString());
      console.log("MPC Authority:", mpcAuthority.toString());

      // Fetch and verify the bridge config
      const config = await program.account.bridgeConfig.fetch(bridgeConfigPda);
      console.log("\nBridge Config Details:");
      console.log("- Admin:", config.admin.toString());
      console.log("- Enclave Authority:", config.enclaveAuthority.toString());
      console.log("- MPC Authority:", config.mpcAuthority.toString());
      console.log("- sZEC Mint:", config.szecMint.toString());
      console.log("- Deposit Nonce:", config.depositNonce.toString());
      console.log("- Burn Nonce:", config.burnNonce.toString());
      console.log("- Total Minted:", config.totalMinted.toString());
      console.log("- Total Burned:", config.totalBurned.toString());

    } catch (error) {
      console.error("Initialization failed:");
      console.error(error);
      throw error;
    }
  });

  it("Initializes computation definitions", async () => {
    console.log("\nInitializing computation definitions...");

    // For Arcium, computation definitions need to be initialized
    // This would typically be done through arcium CLI or specific calls
    // For now, we'll skip this in basic testing

    console.log("Note: Computation definitions should be initialized via arcium CLI");
    console.log("Run: arcium init-mxe --program-id", program.programId.toString());
  });
});
